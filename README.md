# Sunshine Analysis Plugin for QGIS

## 概述

Sunshine Analysis 是一个专业的 QGIS 插件，用于计算日出方位角和进行日出可见性分析。该插件可以帮助用户评估地形对日出观看条件的影响，为观景点选择、旅游规划、建筑设计等提供科学依据。

## 主要功能

### 1. 日出方位角计算
- 支持指定日期和位置的精确日出方位角计算
- 使用天文算法（如果安装了astral库）或简化算法
- 考虑地球曲率和纬度影响

### 2. 日出可见性分析
- 基于DEM数据进行地形遮挡分析
- 使用射线追踪算法评估每个点的日出观看条件
- 输出0-5分的评分结果
- 支持大量点数据的批量处理
- 多进程并行计算，提高处理效率

### 3. 结果可视化
- 自动生成评分分布图
- 支持结果图层自动加载到QGIS
- 生成统计报告

## 安装要求

### QGIS版本
- QGIS 3.0 或更高版本

### Python依赖包
```bash
pip install numpy>=1.20.0
pip install scipy>=1.7.0
pip install geopandas>=0.10.0
pip install pyproj>=3.0.0
pip install matplotlib>=3.3.0
pip install tqdm>=4.60.0
pip install astral>=2.2  # 可选，用于精确天文计算
```

### 可选依赖
- `cupy>=9.0.0`: GPU加速支持（需要CUDA环境）

## 安装方法

### 方法1：手动安装
1. 下载插件文件
2. 将插件文件夹复制到QGIS插件目录：
   - Windows: `C:\Users\[用户名]\AppData\Roaming\QGIS\QGIS3\profiles\default\python\plugins\`
   - Linux: `~/.local/share/QGIS/QGIS3/profiles/default/python/plugins/`
   - macOS: `~/Library/Application Support/QGIS/QGIS3/profiles/default/python/plugins/`
3. 重启QGIS
4. 在插件管理器中启用插件

### 方法2：使用QGIS插件管理器
1. 在QGIS中打开插件管理器
2. 点击"安装插件"
3. 选择插件压缩包进行安装

## 使用方法

### 基本操作流程

1. **启动插件**
   - 在QGIS菜单栏选择 "插件" → "Sunshine Analysis" → "日出分析工具"

2. **设置输入文件**
   - DEM文件：选择数字高程模型文件（支持.tif, .tiff, .asc等格式）
   - 点数据文件：选择要分析的点数据（支持.shp, .gpkg, .geojson等格式）
   - 输出文件：设置结果保存路径

3. **配置分析参数**
   - 选择分析日期
   - 调整最大分析距离（默认50km）
   - 设置初始步长（默认100m）
   - 配置批次大小（默认500个点）

4. **执行分析**
   - 点击"计算日出方位角"：仅计算当前地图中心点的方位角
   - 点击"开始分析"：执行完整的可见性分析

### 参数说明

#### 最大分析距离
- 范围：1-100公里
- 影响：决定射线追踪的最大距离，距离越大分析越精确但耗时越长

#### 初始步长
- 范围：10-1000米
- 影响：射线追踪的步长，步长越小精度越高但计算量越大

#### 批次大小
- 范围：100-10000个点
- 影响：多进程处理的批次大小，影响内存使用和并行效率

### 评分标准

- **5分**：无遮挡，视野完全开阔
- **4分**：轻微遮挡，基本不影响观看日出
- **3分**：部分遮挡，日出观看效果一般
- **2分**：严重遮挡，日出观看效果较差
- **1分**：几乎完全遮挡，很难看到日出
- **0分**：完全遮挡，无法看到日出

## 输出结果

### 文件输出
- **GeoPackage文件**：包含原始点数据和新增的评分字段
- **可视化图片**：评分分布图和密度图
- **统计报告**：平均分、最高分、最低分等统计信息

### 字段说明
- `azimuth`：日出方位角（度）
- `score`：日出可见性评分（0-5分）

## 性能优化

### 硬件建议
- **CPU**：多核处理器，建议4核以上
- **内存**：建议8GB以上，大数据集需要16GB以上
- **存储**：SSD硬盘可提高I/O性能

### 参数调优
- 对于小数据集（<1000点）：可使用较小的最大距离和步长
- 对于大数据集（>10000点）：建议增大批次大小和步长
- 对于高精度要求：减小步长，增大最大距离

## 常见问题

### Q1: 分析速度很慢怎么办？
A: 可以尝试以下方法：
- 增大初始步长
- 减小最大分析距离
- 增大批次大小
- 使用更少的CPU核心（减少系统负载）

### Q2: 内存不足怎么办？
A: 可以尝试以下方法：
- 减小批次大小
- 分批处理数据
- 关闭其他应用程序释放内存

### Q3: 结果不准确怎么办？
A: 请检查：
- DEM和点数据是否使用相同的坐标系
- DEM分辨率是否足够（建议<30m）
- 分析参数是否合适

### Q4: 插件无法启动怎么办？
A: 请检查：
- 是否安装了所有必需的Python包
- QGIS版本是否兼容
- 插件是否正确安装

## 技术支持

如果您遇到问题或有改进建议，请：
1. 查看QGIS日志信息
2. 检查Python依赖包是否正确安装
3. 联系开发团队

## 版本历史

### v1.0 (2025-01-27)
- 初始版本发布
- 支持日出方位角计算
- 支持日出可见性分析
- 支持多进程并行计算
- 支持结果可视化

## 许可证

本插件采用GPL v2许可证，详见LICENSE文件。

## 致谢

感谢以下开源项目的支持：
- QGIS
- NumPy
- SciPy
- GeoPandas
- Matplotlib
- Astral (可选) 