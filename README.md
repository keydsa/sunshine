# Sunshine Analysis Plugin for QGIS

## 概述

Sunshine Analysis 是一个专业的 QGIS 插件，用于计算日出方位角和进行日出可见性分析。该插件可以帮助用户评估地形对日出观看条件的影响，为观景点选择、旅游规划、建筑设计等提供科学依据。

## 主要功能

### 1. 日出可见性分析
- 基于DEM数据进行地形遮挡分析
- 使用射线追踪算法评估每个点的日出观看条件
- 输出0-5分的评分结果
- 支持大量点数据的批量处理
- 多进程并行计算，提高处理效率
- **自动坐标变换**：支持任意坐标系输入，自动转换为WGS84进行分析
- **智能数据源选择**：支持从文件或QGIS项目图层选择输入数据

### 2. 输出坐标系选择
- 与项目坐标系一致
- 与输入点图层一致
- WGS84坐标系
- 自定义坐标系（通过QGIS坐标系选择器）

### 3. 结果可视化
- 自动生成点矢量结果文件（GeoPackage格式）
- 支持结果图层自动加载到QGIS
- 包含日出方位角和可见性评分字段

## 安装要求

### QGIS版本
- QGIS 3.0 或更高版本

### Python依赖包
```bash
pip install numpy>=1.20.0
pip install scipy>=1.7.0
pip install geopandas>=0.10.0
pip install pyproj>=3.0.0
pip install tqdm>=4.60.0  # 可选，用于进度条显示
pip install astral>=2.2  # 可选，用于精确天文计算
```

### 可选依赖
- `cupy>=9.0.0`: GPU加速支持（需要CUDA环境）
  - 安装CUDA Toolkit: https://developer.nvidia.com/cuda-downloads
  - 安装CuPy: `pip install cupy-cuda11x` (根据您的CUDA版本选择)

## 安装方法

### 方法1：手动安装
1. 下载插件文件
2. 将插件文件夹复制到QGIS插件目录：
   - Windows: `C:\Users\[用户名]\AppData\Roaming\QGIS\QGIS3\profiles\default\python\plugins\`
   - Linux: `~/.local/share/QGIS/QGIS3/profiles/default/python/plugins/`
   - macOS: `~/Library/Application Support/QGIS/QGIS3/profiles/default/python/plugins/`
3. 重启QGIS
4. 在插件管理器中启用插件

### 方法2：使用QGIS插件管理器
1. 在QGIS中打开插件管理器
2. 点击"安装插件"
3. 选择插件压缩包进行安装

## 使用方法

### 基本操作流程

1. **启动插件**
   - 在QGIS菜单栏选择 "插件" → "Sunshine Analysis" → "日出分析工具"

2. **设置输入数据**
   - **DEM数据**：
     - 文件方式：选择数字高程模型文件（支持.tif, .tiff, .asc等格式）
     - 图层方式：从当前QGIS项目中选择DEM图层
   - **点数据**：
     - 文件方式：选择要分析的点数据（支持.shp, .gpkg, .geojson等格式）
     - 图层方式：从当前QGIS项目中选择点图层
   - **输出文件**：设置结果保存路径（留空则自动生成临时文件）

3. **配置分析参数**
   - 选择分析日期
   - 调整最大分析距离（默认50km）
   - 设置初始步长（默认100m）
   - 配置批次大小（默认500个点）
   - **启用GPU加速**（可选，需要安装CuPy和CUDA）

4. **设置输出坐标系**
   - 选择输出结果的坐标系
   - 可选择"自定义..."并点击"选择"按钮打开坐标系选择器

5. **执行分析**
   - 点击"开始分析"按钮执行完整的可见性分析

### 参数说明

#### 最大分析距离
- 范围：1-100公里
- 影响：决定射线追踪的最大距离，距离越大分析越精确但耗时越长

#### 初始步长
- 范围：10-1000米
- 影响：射线追踪的步长，步长越小精度越高但计算量越大

#### 批次大小
- 范围：100-10000个点
- 影响：多进程处理的批次大小，影响内存使用和并行效率

#### GPU加速
- 功能：启用GPU加速计算，大幅提升处理速度
- 要求：需要安装CUDA Toolkit和CuPy
- 优势：对于大数据集（>10000点）可提升5-10倍性能

### 评分标准

- **5分**：无遮挡，视野完全开阔
- **4分**：轻微遮挡，基本不影响观看日出
- **3分**：部分遮挡，日出观看效果一般
- **2分**：严重遮挡，日出观看效果较差
- **1分**：几乎完全遮挡，很难看到日出
- **0分**：完全遮挡，无法看到日出

## 输出结果

### 文件输出
- **GeoPackage文件**：包含原始点数据和新增的评分字段
- 自动加载到QGIS地图中

### 字段说明
- `azimuth`：日出方位角（度）
- `score`：日出可见性评分（0-5分）

## 坐标系处理

### 自动坐标变换
- 插件会自动将输入数据转换为WGS84坐标系进行分析
- 分析完成后将结果转换回用户选择的输出坐标系
- 支持任意坐标系的输入数据

### 输出坐标系选项
1. **与项目坐标系一致**：使用当前QGIS项目的坐标系
2. **与输入点图层一致**：使用输入点图层的坐标系
3. **WGS84**：使用WGS84坐标系（EPSG:4326）
4. **自定义**：通过QGIS坐标系选择器选择任意坐标系

## 性能优化

### 硬件建议
- **CPU**：多核处理器，建议4核以上
- **内存**：建议8GB以上，大数据集需要16GB以上
- **存储**：SSD硬盘可提高I/O性能

### 参数调优
- 对于小数据集（<1000点）：可使用较小的最大距离和步长
- 对于大数据集（>10000点）：建议增大批次大小和步长
- 对于高精度要求：减小步长，增大最大距离

## 常见问题

### Q1: 分析速度很慢怎么办？
A: 可以尝试以下方法：
- 增大初始步长
- 减小最大分析距离
- 增大批次大小
- 使用更少的CPU核心（减少系统负载）

### Q2: 内存不足怎么办？
A: 可以尝试以下方法：
- 减小批次大小
- 分批处理数据
- 关闭其他应用程序释放内存

### Q3: 结果不准确怎么办？
A: 请检查：
- DEM分辨率是否足够（建议<30m）
- 分析参数是否合适
- 输入数据质量

### Q4: 坐标系选择按钮点击不了怎么办？
A: 坐标系选择按钮只有在选择"自定义..."选项时才会启用。请先在下拉框中选择"自定义..."，然后点击"选择"按钮。

### Q5: GPU加速功能不可用怎么办？
A: GPU加速需要以下组件：
1. NVIDIA显卡和CUDA Toolkit
2. CuPy库：`pip install cupy-cuda11x` (根据您的CUDA版本选择)
3. 安装完成后重启QGIS

如果GPU不可用，插件会自动回退到CPU计算，不影响正常使用。

### Q6: 插件无法启动怎么办？
A: 请检查：
- 是否安装了所有必需的Python包
- QGIS版本是否兼容
- 插件是否正确安装

## 版本更新说明

### v1.1 (最新版本)
- **新增功能**：
  - 支持从QGIS项目图层选择输入数据
  - 输出坐标系选择功能
  - 自动坐标变换支持
  - 输出为点矢量文件（GeoPackage）
  - 改进的用户界面设计
  - **GPU加速支持**：大幅提升大数据集处理速度
- **移除功能**：
  - 单独的日出方位角计算按钮
  - matplotlib绘图功能
  - 栅格输出格式

### v1.0 (初始版本)
- 支持日出方位角计算
- 支持日出可见性分析
- 支持多进程并行计算
- 支持结果可视化

## 技术支持

如果您遇到问题或有改进建议，请：
1. 查看QGIS日志信息
2. 查看错误处理文档
3. 检查Python依赖包是否正确安装
4. 联系作者

## 致谢

感谢以下开源项目的支持：
- QGIS
- NumPy
- SciPy
- GeoPandas
- Astral 